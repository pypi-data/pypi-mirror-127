<metal:main use-macro="load: ${layout}"
            xmlns:tal="http://xml.zope.org/namespaces/tal"
            xmlns:metal="http://xml.zope.org/namespaces/metal">

  <link metal:fill-slot="css" tal:omit-tag="">
    <link rel="stylesheet" href="${theme}/css/jquery-ui.css"
          type="text/css" media="screen"/>
  </link>

  <script metal:fill-slot="js" tal:omit-tag="">
    <script src="${theme}/js/jquery-ui.js"></script>
    <script src="${theme}/js/chrysalio-filter.js"></script>
  </script>

  <div metal:fill-slot="form_begin" tal:omit-tag="">
    ${form.begin(request.current_route_path(_anchor='current'), multipart=True)}
    ${form.default_button('filter')}
  </div>

  <!-- .............................. Main Buttons ........................ -->
  <div id="cioMainButtons" metal:fill-slot="main_buttons"
       tal:condition="i_creator" tal:switch="action == 'imp?'">
    <div tal:case="True" tal:omit-tag="">
      ${form.upload('file', multiple="multiple")}
      ${form.submit('imp!.x', _('Import file'), class_='cioButton cioButtonSmall')}
      ${form.submit_cancel(_('Cancel'), theme+'/images/action_cancel.png')}
    </div>
    <div tal:case="False" tal:omit-tag="">
      <div class="cioProgress cioHidden" >
        <div class="cioBar"></div><div class="cioPercent">0%</div>
      </div>
      ${form.upload('file', multiple="multiple", data_max_size=download_max_size,
        class_='cioHidden')}
      ${form.submit('imp?.x', _('Import'), class_='cioButton cioInputFile')}
      ${form.button(route('user_create', _anchor='tabUser0'), label=_('Create'))}
    </div>
  </div>

  <div id="cioContainer" metal:fill-slot="container">
    <!-- ............................... Flash ............................ -->
    <div tal:define="flash load: flash_snackbar.macro.pt"
         metal:use-macro="flash"/>

    <div id="cioContent">
      <!-- .............................. List ............................ -->
      <div class="cioPagingList" tal:condition="paging.display == 'list'">
        <div class="cioSticky">
          <div tal:define="paging_filter load: paging_filter.macro.pt"
               metal:use-macro="paging_filter"/>
        </div>

        <table>
          <caption>${_('Users')}</caption>
          <thead>
            <tr>
              <th class="cioCheckbox" id="check_all"></th>
              <th>${paging.sortable_column(_('Login'), 'login')}</th>
              <th class="cioOptional">${paging.sortable_column(_('First name'), 'first_name')}</th>
              <th>${paging.sortable_column(_('Last name'), 'last_name')}</th>
              <th class="cioOptional">${paging.sortable_column(_('Email'), 'email')}</th>
              <th class="cioOptional">${paging.sortable_column(_('Status'), 'status')}</th>
              <th>${paging.sortable_column(_('Last connection'), 'last_login')}</th>
              <th class="cioActions" tal:condition="i_editor">
                <span tal:condition="i_creator and action == 'del?#'" tal:omit-tag="">
                  ${form.submit('del!#.x',
                    _('Confirm the deletion of ${n} user(s)', {'n': len(items)}),
                    class_='cioButton cioButtonSmall cioButtonAlert')}
                  ${form.submit_cancel(_('Cancel'), theme+'/images/action_cancel.png')}
                </span>
                <span tal:condition="i_editor and action == 'mel?#'" tal:omit-tag="">
                  ${form.submit('mel!#.x', _('Confirm sending'), class_='cioButton cioButtonSmall')}
                  ${form.submit_cancel(_('Cancel'), theme+'/images/action_cancel.png')}
                </span>
                <span tal:condition="action not in ('del?#', 'mel?#')" tal:omit-tag="">
                  <span tal:condition="i_editor" tal:omit-tag="">
                    ${form.submit_image('mel?#', _('Send an invitation'),
                      theme+'/images/action_email.png')}
                    ${form.submit_image('exp!#', _('Export selected users'),
                      theme+'/images/action_export.png')}
                  </span>
                  <span tal:condition="i_creator" tal:omit-tag="">
                    ${form.submit_image('del?#', _('Delete selected users'),
                      theme+'/images/action_delete.png')}
                  </span>
                </span>
              </th>
            </tr>
          </thead>

          <tbody>
            <tr tal:repeat="dbuser paging">
              <td class="cioCheckbox cioSelect">
                ${form.custom_checkbox('#{0}'.format(dbuser.user_id))}
              </td>
              <td>
                <a href="${route('user_view', user_id=dbuser.user_id)}">${dbuser.login}</a>
              </td>
              <td class="cioOptional">
                <a href="${route('user_view', user_id=dbuser.user_id)}">${dbuser.first_name}</a>
              </td>
              <td>
                <a href="${route('user_view', user_id=dbuser.user_id)}">${dbuser.last_name}</a>
              </td>
              <td class="cioOptional">
                ${(i_editor or not dbuser.email_hidden) and dbuser.email or ''}
              </td>
              <td class="cioOptional">${status_labels[dbuser.status]}</td>
              <td title="${dbuser.last_login and dbuser.last_login.isoformat(' ').partition('.')[0] or ''}">
                ${age(dbuser.last_login)}
              </td>
              <td class="cioActions" tal:condition="i_editor">
                <span tal:condition="action == 'mel?{0}'.format(dbuser.user_id)" id="current">
                  ${form.submit('mel!{0}.x'.format(dbuser.user_id), _('Confirm sending'),
                    class_='cioButton cioButtonSmall')}
                  ${form.submit_cancel(_('Cancel'), theme+'/images/action_cancel.png')}
                </span>
                <span tal:condition="action[4:] != str(dbuser.user_id)" tal:omit-tag="">
                  ${form.submit_image('mel?{0}'.format(dbuser.user_id), _('Send an invitation'),
                    theme+'/images/action_email_one.png')}
                  ${form.submit_image('exp!{0}'.format(dbuser.user_id), _('Export user'),
                    theme+'/images/action_export_one.png')}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- .............................. Cards ........................... -->
      <div class="cioPagingCards" tal:condition="paging.display == 'cards'">
        <div class="cioSticky">
          <div tal:define="paging_filter load: paging_filter.macro.pt"
               metal:use-macro="paging_filter"/>

          <div class="cioPagingBar cioFlexRowContainer">
            <div class="cioPagingSort cioFlexItem">
              <span class="cioCheckbox" id="check_all"></span>
              ${paging.sortable_column(_('Login'), 'login')}
              ${paging.sortable_column(_('First name'), 'first_name')}
              ${paging.sortable_column(_('Last name'), 'last_name')}
              ${paging.sortable_column(_('Email'), 'email')}
              ${paging.sortable_column(_('Status'), 'status')}
              ${paging.sortable_column(_('Last connection'), 'last_login')}
            </div>
            <div class="cioActions" tal:condition="i_editor">
              <span tal:condition="i_creator and action == 'del?#'" tal:omit-tag="">
                ${form.submit('del!#.x',
                  _('Confirm the deletion of ${n} user(s)', {'n': len(items)}),
                  class_='cioButton cioButtonSmall cioButtonAlert')}
                ${form.submit_cancel(_('Cancel'), theme+'/images/action_cancel.png')}
              </span>
              <span tal:condition="i_editor and action == 'mel?#'" tal:omit-tag="">
                ${form.submit('mel!#.x', _('Confirm sending'), class_='cioButton cioButtonSmall')}
                ${form.submit_cancel(_('Cancel'), theme+'/images/action_cancel.png')}
              </span>
              <span tal:condition="action not in ('del?#', 'mel?#')" tal:omit-tag="">
                <span tal:condition="i_editor" tal:omit-tag="">
                  ${form.submit_image('mel?#', _('Send an invitation'),
                   theme+'/images/action_email.png')}
                  ${form.submit_image('exp!#', _('Export selected users'),
                   theme+'/images/action_export.png')}
                </span>
                <span tal:condition="i_creator" tal:omit-tag="">
                  ${form.submit_image('del?#', _('Delete selected users'),
                  theme+'/images/action_delete.png')}
                </span>
              </span>
            </div>
          </div>
        </div>

        <ul class="cioPagingCardsArea cioFlexRowContainer${has_attachments and ' cioAttachments' or ''}">
          <li tal:repeat="dbuser paging" class="cioPagingCard cioFlexColumnContainer">
            <div class="cioFlexItem cioFlexColumnContainer">
              <a href="${route('user_view', user_id=dbuser.user_id)}" class="cioFlexItem">
                <div tal:condition="has_attachments" class="cioPagingCardPicture">
                  <img src="${attachment_url(request, dbuser.attachments_dir, dbuser.attachments_key, dbuser.picture) \
                            or dbuser.honorific == 'Mrs' and theme+'/images/user_picture_girl.svg' \
                            or theme+'/images/user_picture_boy.svg'}"
                       alt="photo"/>
                </div>
                <div class="cioPagingCardStatus">
                  <img src="${theme}/images/status_${dbuser.status}.png"
                       alt="${dbuser.status}" title="${status_labels[dbuser.status]}"/>
                </div>
                <div class="cioPagingCardTitle">
                  ${dbuser.first_name} ${dbuser.last_name}
                </div>
                <div class="cioPagingCardSubtitle">${dbuser.login}</div>
                <div tal:condition="(i_editor or not dbuser.email_hidden) and dbuser.email">
                  ${_('Email: ${e}', {'e': dbuser.email})}
                </div>
                <div tal:condition="dbuser.last_login"
                     title="${dbuser.last_login and dbuser.last_login.isoformat(' ').partition('.')[0]}">
                  ${_('Last connection: ${c}', {'c': _(age(dbuser.last_login))})}
                </div>
              </a>
              <div class="cioActions cioFlexRowContainer">
                <div class="cioFlexItem">
                  <span tal:condition="action == 'mel?{0}'.format(dbuser.user_id)" id="current">
                    ${form.submit('mel!{0}.x'.format(dbuser.user_id), _('Confirm sending'),
                      class_='cioButton cioButtonSmall')}
                    ${form.submit_cancel(_('Cancel'), theme+'/images/action_cancel.png')}
                  </span>
                  <span tal:condition="action[4:] != str(dbuser.user_id)" tal:omit-tag="">
                    ${form.submit_image('mel?{0}'.format(dbuser.user_id), _('Send an invitation'),
                      theme+'/images/action_email_one.png')}
                    ${form.submit_image('exp!{0}'.format(dbuser.user_id), _('Export user'),
                      theme+'/images/action_export_one.png')}
                  </span>
                </div>
                <div class="cioSelect">
                  ${form.custom_checkbox('#{0}'.format(dbuser.user_id))}
                </div>
              </div>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <div metal:fill-slot="form_end" tal:omit-tag="">${form.end()}</div>
</metal:main>
